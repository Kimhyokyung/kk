<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="listener">
	<select id="selectByEmail" parameterType="string" resultType="ListenerVo">
	<![CDATA[
		select email
		from tb_listener
	    where email = #{email}
	]]>
	</select>
	
	<insert id="insert" parameterType="ListenerVo">
		<![CDATA[		
		insert 
		into tb_listener
		(email, password, nickname, consulting_topic)
		values (#{email}, #{password}, #{nickname}, #{consulting_topic})	
		]]>
	</insert>
	
	<update id="update" parameterType="ListenerVo">
		<![CDATA[		
		update tb_listener
		set password=#{password}, nickname=#{nickname}, consulting_topic=#{consulting_topic}
		where email=#{email}
		]]>
	</update>
	
	<delete id="delete" parameterType="TalkerVo">
		<![CDATA[		
		delete from tb_listener
		where email=#{email}
		]]>
	</delete>
	
	<select id="selectByEmailAndPassword" parameterType="map" resultType="ListenerVo">
		<![CDATA[
		select email, nickname, password
		from tb_listener
		where email=#{email} and password=#{password}
		]]>
	</select>

	<select id="selectListenerList" parameterType="map" resultType="map">
		<![CDATA[
		select IDX, EMAIL, NICKNAME, PASSWORD, CONSULTING_TOPIC from tb_listener;
			]]>
	</select>
	
	<select id="read" resultType="ListenerVo">
		<![CDATA[
		select IDX, EMAIL, NICKNAME, PASSWORD, CONSULTING_TOPIC from tb_listener where IDX = #{IDX};
			]]>
	</select>
	
	<select id="listPage" resultType="ListenerVo">
		<![CDATA[
		select IDX, EMAIL, NICKNAME, PASSWORD, CONSULTING_TOPIC from tb_listener where IDX > 0 order by IDX desc, NICKNAME desc limit #{page}, 10;
			]]>
	</select>
	
	<select id="listCriteria" parameterType="Criteria" resultType="ListenerVo">
		<![CDATA[
			select
				IDX, EMAIL, NICKNAME, PASSWORD, CONSULTING_TOPIC
			from
				tb_listener
			where IDX > 0
			order by IDX desc, NICKNAME desc
			limit #{pageStart}, #{perPageNum}
		]]>
	</select>
	
	<select id="countPaging" resultType="int">
		<![CDATA[
		select count(IDX) from tb_listener where IDX > 0
		]]>
	</select>
	
	<select id="listSearch" resultType="ListenerVo">
		<![CDATA[
			select * from tb_listener
			where idx > 0
			]]>
		<include refid="search"></include>
		<include refid="search_score"></include>	
		<![CDATA[
			limit #{pageStart}, #{perPageNum}
		]]>
	</select>
	
	<select id="listSearchCount" resultType="int">
		<![CDATA[
			select count(idx)
			from tb_listener
			where idx > 0
			]]>
		<include refid="search"></include>
	</select>
	
	
	<sql id="search">
		<if test="searchType != null">
			<!-- 상담주제 -->
			<if test="searchType == 'job'.toString()">
				and CONSULTING_TOPIC like CONCAT('%', '직장문제', '%')
			</if>
			<if test="searchType == 'school'.toString()">
				and CONSULTING_TOPIC like CONCAT('%', '학교문제', '%')
			</if>
			<if test="searchType == 'course'.toString()">
				and CONSULTING_TOPIC like CONCAT('%', '진로상담', '%')
			</if>
			<if test="searchType == 'smoke'.toString()">
				and CONSULTING_TOPIC like CONCAT('%', '금주/금연', '%')
			</if>
			<if test="searchType == 'finance'.toString()">
				and CONSULTING_TOPIC like CONCAT('%', '재정문제', '%')
			</if>
			<if test="searchType == 'diet'.toString()">
				and CONSULTING_TOPIC like CONCAT('%', '다이어트', '%')
			</if>
			<if test="searchType == 'reason'.toString()">
				and CONSULTING_TOPIC like CONCAT('%', '이성문제', '%')
			</if>
			<if test="searchType == 'etc'.toString()">
				and CONSULTING_TOPIC like CONCAT('%', '기타', '%')
			</if>
		</if>
	</sql>
	
	<sql id="search_score">
		<if test="searchType_score != null">
			<!-- 평점 -->
			<if test="searchType_score == 'high'.toString()">
				order by score desc
			</if>
			<if test="searchType_score == 'low'.toString()">
				order by score asc
			</if>
		</if>
	</sql>
	
</mapper>